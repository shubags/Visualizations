<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Jason Shu's Visualization Final Project</title>

<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/bootstrap-theme.min.css" rel="stylesheet">

<style type="text/css">
    body {
        padding-top: 50px;
        padding-bottom: 20px;
    }

/*    .axis text {
        font-family: sans-serif;
        font-size: 16px;
    }
*/
    .axis text {
      font: 12px sans-serif;
    }

    .axis path,
    .axis line {
      fill: none;
      stroke: #000;
      shape-rendering: crispEdges;
    }

    .bar {
      fill: blue;
      fill-opacity: .9;
    }

    .x.axis path {
      display: none;
    }

    /*slider formats*/
    .sliderAxis {
      fill: black;
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
    }

    .sliderAxis .halo {
      stroke: black;
      stroke-width: 1px;
      stroke-linecap: round;
    }

    .slider .handle path {
      stroke: black;
      stroke-width: 10px;
      stroke-linecap: round;
      pointer-events: none;
    }

    .slider .handle text {
      fill: black;
      text-align: center;
      font-size: 20px;
    }
    /*end slider formats*/

    label {
      position: relative;
      top: 10px;
      left: 400px;
    }

    #updateBar {
      position: relative;
      top: 10px;
      left: 350px;
    }


    .brush .extent {
      stroke: #fff;
      fill-opacity: .125;
      shape-rendering: crispEdges;
    }


   .d3-tip {
      line-height: 1;
      font-weight: bold;
      padding: 12px;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      border-radius: 2px;
    }

    /* Creates a small triangle extender for the tooltip */
    .d3-tip:after {
      box-sizing: border-box;
      display: inline;
      font-size: 10px;
      width: 100%;
      line-height: 1;
      color: rgba(0, 0, 0, 0.8);
      content: "\25BC";
      position: absolute;
      text-align: center;
    }

    /* Style northward tooltips differently */
    .d3-tip.n:after {
      margin: -1px 0 0 0;
      top: 100%;
      left: 0;
    }


/*    .legend text {
      fill: #777;
      font: 10px sans-serif;
      text-anchor: middle;
    }
*/
    .frame {
      fill: none;
      stroke: #aaa;
    }

    .axis,
    .frame {
      shape-rendering: crispEdges;
    }

    .axis path,
    .axis line {
      fill: none;
      stroke: #000;
      shape-rendering: crispEdges;
    }

/*    .x.axis path {
      display: none;
    }
*/
    .line {
      fill: none;
      stroke: steelblue;
      stroke-width: 1.5px;
    }

</style>

</head>

<body>
<script src="d3.v3.min.js"></script>
<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="d3.tip.v0.6.3.js"></script>
<script src="/js/colorbrewer.js"></script>

<!-- Fixed Navbar -->
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle Navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#">MSN 622</a>
        </div>

        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li><a href="#homework">Homework</a></li>
                <li><a href="#project">Project</a></li>
                <li><a href="#participation">Participation</a></li>
            </ul>

            <ul class="nav navbar-nav navbar-right">
                <li><a href="#about">About</a></li>
                <li><a href="#contact">Contact</a></li>
            </ul>
        </div><!--/.nav-collapse -->
    </div>
</nav>

<!-- <div class="jumbotron"> -->
<div style="background-color: #eee">
    <div class="container">
        <h1 style="font-size: 32px">Jason Shu's Final Project</h1>

        <h3 style="font-size: 20px">Visualization Prototype</h3>
        <p style="font-size: 14px">Click <a href="https://github.com/shubags/Visualizations/tree/gh-pages/final_project/prototype">here</a> for source code</p>

    </div>
</div>

<div id="myPlot3" style="display: block; margin-left: auto; margin-right: auto;"></div>
<script src="brushPlot.js"></script>
<div style="height: 25px;"></div>


<button id="updateBar" onClick="updateBarChart()">Update Spending</button>
<label><input type="checkbox"> Sort values</label>
<!-- <script src="slider.js"></script> -->
<div id="slider">
<script>

// ####################################  BEGIN SLIDER SCRIPT ####################################

  // parameters
  var sliderMargin = {
      top: 10,
      right: 50,
      bottom: 0,
      left: 50
    },
    sliderWidth = 960 - sliderMargin.left - sliderMargin.right,
    sliderHeight = 120 - sliderMargin.bottom - sliderMargin.top;


  // scale function
  var timeScale = d3.time.scale()
    .domain([new Date('1951'), new Date('2015')])
    .range([0, sliderWidth])
    .clamp(true);

  // initial value
  var startValue = timeScale(new Date('1951'));
  startingValue = new Date('1951');

  //////////

  // defines brush
  var brush = d3.svg.brush()
    .x(timeScale)
    .extent([startingValue, startingValue])
    .on("brush", brushed);

var svg2 = d3.select("#slider").append("svg")
  .attr("width", sliderWidth + sliderMargin.left + sliderMargin.right)
  .attr("height", sliderHeight + sliderMargin.top + sliderMargin.bottom)
  .append("g")
  // classic transform to position g
  .attr("transform", "translate(" + sliderMargin.left + "," + sliderMargin.top + ")");

var formatDate = d3.time.format("%Y")

  var sliderAxis = svg2.append("g")
    .attr("class", "sliderAxis")
    // .attr("class", "x axis")
  // put in middle of screen
  .attr("transform", "translate(0," + sliderHeight / 2 + ")")
  // inroduce axis


  sliderAxis.call(d3.svg.axis()
    .scale(timeScale)
    .orient("bottom")
    .tickFormat(function(d) {
      return formatDate(d);
    })
    .tickSize(0)
    .tickPadding(12)
    .tickValues([timeScale.domain()[0], timeScale.domain()[1]]))
    .select(".domain")
    .select(function() {
      console.log(this);
      return this.parentNode.appendChild(this.cloneNode(true));
    })
    .attr("class", "halo");

  var slider = svg2.append("g")
    .attr("class", "slider")
    .call(brush);

  // slider.selectAll(".extent,.resize")
  //   .remove();

  slider.select(".background")
    .attr("height", sliderHeight);

  var handle = slider.append("g")
    .attr("class", "handle");

  handle.append("path")
    .attr("transform", "translate(0," + sliderHeight / 2 + ")")
    .attr("d", "M 0 -5 V 5")

  handle.append('text')
    .text(startingValue)
    .attr("transform", "translate(" + (-22) + " ," + (sliderHeight / 2 - 15) + ")");

  slider
    .call(brush.event)

  chartYear = 1950

  function brushed() {

    value = brush.extent()[0];

    if (d3.event.sourceEvent) { // not a programmatic event
      value = timeScale.invert(d3.mouse(this)[0]);
      brush.extent([value, value]);
    }
    chartYear = formatDate(value);

    handle.attr("transform", "translate(" + timeScale(value) + ",0)");
    handle.select('text').text(chartYear);

    // console.log(formatDate(value));
  };
// ####################################  END SLIDER SCRIPT ####################################
// ####################################  BEGIN BAR CHART SCRIPT ####################################
function updateBarChart(value) {
    // get query string from the input box instead of the window
    d3.select("#barChart").select("svg").remove()

    makeBarChart(chartYear);
}
</script>
</div>

<div id="barChart">
<script>
function makeBarChart(chartYear){

var margin = {top: 0, right: 20, bottom: 80, left: 40},
    width = 960 - margin.left - margin.right,
    height = 350 - margin.top - margin.bottom

var parseDate = d3.time.format("%Y").parse;

var formatPercent = d3.format(".0%");

var x = d3.scale.ordinal()
    .rangeRoundBands([0, width], .1, 1);

var y = d3.scale.linear()
    .range([height, 0]);

var yearScale = d3.scale.ordinal()

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom");

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left")
    // .tickFormat(formatPercent)
    ;

// d3.select("#barChart").remove()
var svg = d3.select("#barChart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .attr("display", "block")
    .attr("left-margin", "auto")
    .attr("right-margin", "auto")
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

d3.csv("natoSpending_BY_YEAR.csv", function(error, data) {

  
  years = d3.keys(data[0]).filter(function(key) { return key !== "name"; });
  yearsDt = years.map(function(d){return parseDate(d);});

  yearScale.range(d3.range(0,years.length,1))
    .domain(years);

  var spending = years.map(function(year) {
    return {
      year: year,
      values: data.map(function(d) {
        return {name: d.name, spending: +d[year]};
      })
    };
  });

  countries = spending[0].values.map(function(d){return d.name;}).sort();

  x.domain(countries);
  // y.domain([0, d3.max(spending[yearScale(chartYear)].values, function(d) { return d.spending;})]);

  y.domain([0, d3.max(spending, function(c) { return d3.max(c.values, function(v){ return v.spending; });})]);
  
  svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis)
      .selectAll("text")
        .style("text-anchor", "end")
        .attr("dx", "-1.2em")
        .attr("dy", ".15em")
        .attr("transform", function(d) {return "rotate(-65)" })
        ;

  svg.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("Defense Spending in Billions of FY11 USD");
  
  svg.selectAll(".bar")
      .data(spending[yearScale(chartYear)].values)
    .enter().append("rect")
      .attr("class", "bar")
      .attr("x", function(d){return x(d.name);})
      .attr("width", x.rangeBand())
      .attr("y", function(d) { return y(d.spending); })
      .attr("height", function(d) { return height - y(d.spending); });

  d3.select("input").on("change", change);

  var sortTimeout = function() {
    d3.select("input").property("checked", true).each(change);
    };

  function change() {
    clearTimeout(sortTimeout);

    // Copy-on-write since tweens are evaluated after a delay.
    var x0 = x.domain(spending[yearScale(chartYear)].values.sort(this.checked
        ? function(a, b) { return b.spending - a.spending; }
        : function(a, b) { return d3.ascending(a.spending, b.spending); })
        .map(function(d) { return d.name; }))
        .copy();

    // countries = x0.domain();

    svg.selectAll(".bar")
        .sort(function(a, b) { return x0(a.name) - x0(b.name); });

    var transition = svg.transition().duration(750),
        delay = function(d, i) { return i * 50; };

    transition.selectAll(".bar")
        .delay(delay)
        .attr("x", function(d) { return x0(d.name); });

    transition.select(".x.axis")
        .call(xAxis)
        .selectAll("text")
        .style("text-anchor", "end")
        .attr("dx", "-1.5em")
        .attr("dy", ".15em")
        .attr("transform", function(d) {return "rotate(-65)" })
      .selectAll("g")
        .delay(delay);
  }
});
};
makeBarChart(1950)
</script>
</div>


<div id="myPlot1" style="display: block; margin: auto;"></div>
<script src="multipleLineTimeSeries.js"></script>

<!-- <div style="height: 10px;"></div>    -->


<!-- <div id="myPlot2" style="display: block; margin: auto;"></div>
<script src="stackedArea.js"></script>

 -->   


<div style="height: 25px;"></div>   

<div class="container">
<div class="row">

<!-- ADD BUTTONS AND STUFF HERE -->

</div>

<div class="col-md-12">
    <h2 class="page-header">Discussion</h2>
</div>



<div>
  <h3>Techniques</h4>

    <p>
      The three plots that were created were done to demonstrate time series nature of this data. There are many stories meant to be shown by the plots shown. The following is a description of why each plot type was chosen.
    </p>
    
    <h5>Plot 1 - The Brushed Area Plot</h2>
    <p>
      One of the stories that I wished to tell was about the global increase in defense spending over time. The defense industry uses these trends to pursue new business. By showing the stacked area plot, one can see how important the United States is to the defense industry as a whole. By itself, the United States more than doubles the spend rate of all other NATO countries combined.
    </p>
    <p>
      The drop off after the United States is significant, and after the top 8, the numbers get too small to see individually on a graph. These 19 countries collectively spend less than the #2 spender in the world, France. As a result, these countries were grouped together in an "Other" bucket to prevent users from attempting to read each individual country.
    </p>
    <h5>Plot 2 - The Sortable Bar Chart</h2>
    <p>
      After recognizing overall growth and the United States' dominance in spending, the next question to be answered is, who <em>were</em> the biggest contributers to NATO spending over time? The sortable bar chart allows users to use a slider to select a point in time where they can compare countries' spending. The purpose of this chart is not to know exactly how much each country has spent, but rather to see where they rank compared to the rest of NATO.
    </p>
    <p>
      One key challenge with this plot is that the United States spends so much more than the other countries that the other bars become indistinguishable. Additionally, the y-axis is scaled to handle the largest value during the period of time of the analysis. This means that during the early years of NATO, when spending was signfiicantly less than during the 2000s, the y-axis seems unnecessarily small. I attempted to re-scale the axis as time passed, but I felt this would introduce significant lie factor.
    </p>
    <h5>Plot 3 - The Multiple-Line Graph</h5>
    <p>
      The overall spending of countries is interesting, but it is misleading because wealthier countries are by nature going to spend more than poorer ones. A common measurement for guaging how important defense spending is to a nation is to measure defense spending as a percentage of GDP.
    </p>
    <p>
      At its inception, NATO guidelines recommended that each member nation spend 2% of its GDP on defense. This level of spending was a threshold deemed indicative of a country's commitment to the alliance. The purpose of the line graph was to show the overall decreasing trend of spending as a percentage of GDP. This type of plot, while a messy, provides a good picture into reduced spending, en masse, over the years.
    </p>
    <h5>Overall</h5>
    <p>
      The plots shown can help tell a story, but there is a bit of lie factor involved with the data. Most noteably, the not all member nations joined at the organization's inception in April 1949. Overall increases seen in Plot 1 are partly due to adding new countries to the plot after they joined. This could be perceived as lie factor and artificial growth.
    </p>
    <p>
      However, the intent of these plots was to show who the most significant contributers were to <em> the organization </em>, not countries overall. To include their spending during years countries were not actually in the organization would introduce a different type of lie factor. Ultimately, I chose the lesser of evils regarding lie factor.
    </p>
</div>


<div>
  <h4>Interactivity</h4>
    <p>

    </p>

</div>

<div>
  <h4>Feedback</h4>
    <p>
      The key feedback received regarding the project prototype was regarding the inclusion of all 26 countries in the stacked area chart. While it is more "exactly" correct to include all of the countries, the point was to show overall growth and that the United States was the dominant spender. As a result, I aggragated the smallest 19 countries into an "other" category.
    </p>
    <p>
      It was also pointed out to me that there were too many digits in the y-axis. I had originally measured spending in millions of US Dollars, in part because several countries had significantly less than $1 billion in spending per year. As a result, I had tried to ensure everybody had values over 1 by reducing the unit size. This, however, caused significant clutter on the plot, and switching to billions as the unit of measurement improved clarity.

</div>

<div>
  <h4>Challenges</h4>

    <p>
      There were singificant challenges encountered throughout this effort. With Plot 1, I had intended to incorporate a tool tip to allow users to see how much spending each country (or group of countries) was spending each year. Ultimately, I was unable to get the tooltip to show up properly.
    </p>
    <p>
      With Plot 2, I had hoped to update the plot automatically (with bar height transitions) as the slider bar was moved. This would be a fun interaction for the user and would allow the user to see how the countries' altered their spending over time. This was to augment the stacked area plot because stacked area plots do not allow users to easily detect changes for any data group except for the bottom one (the one touching the x-axis). Unfortunately, the way that I constructed my plots, the slider bar required manual updating of the data. So while the slider bar is fun, the requirement to hit the "update spending" button prevents the user from gaining true insight in the data.
    </p>
    <p>
      Lastly, I had intended to....
    </p>
</div>

<div>
  <h4>Conclusion</h4>
    <p>
      This data set is very familiar to me, and I have analyzed it in fairly simple ways in Excel. I tend to 
    </p>

</div>


</div>

<hr/>

<footer>
    <p style="text-align: center;">Jason Shu &bullet; MSAN 622 Information Visualization &bullet; Spring 2015</p>
</footer>

</div><!--/.container -->

</body>
</html>
